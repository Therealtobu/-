<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Apple Dashboard</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- C·∫§U H√åNH M√ÄU S·∫ÆC GIAO DI·ªÜN (DARK MODE) --- */
        :root {
            --bg: #000000;          /* M√†u n·ªÅn ch√≠nh (ƒêen) */
            --sidebar: #101012;     /* M√†u n·ªÅn thanh b√™n */
            --card-bg: #1c1c1e;     /* M√†u n·ªÅn th·∫ª/h·ªôp */
            --border: #2c2c2e;      /* M√†u vi·ªÅn */
            --text-primary: #ffffff;
            --text-secondary: #8e8e93;
            --accent: #0a84ff;      /* M√†u xanh Apple */
            --danger: #ff453a;      /* M√†u ƒë·ªè b√°o l·ªói */
            --success: #30d158;     /* M√†u xanh th√†nh c√¥ng */
            --warning: #ffd60a;     /* M√†u v√†ng c·∫£nh b√°o */
        }

        /* --- THI·∫æT L·∫¨P CHUNG --- */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text-primary); font-family: 'Inter', sans-serif; height: 100vh; display: flex; overflow: hidden; }

        /* --- 1. M√ÄN H√åNH GI·ªöI THI·ªÜU (INTRO) --- */
        #intro-layer {
            position: fixed; inset: 0; background: #000; z-index: 99999;
            display: flex; align-items: center; justify-content: center;
            animation: fadeOut 0.8s ease-out 1.5s forwards; pointer-events: none;
        }
        .intro-logo { font-size: 40px; font-weight: 800; letter-spacing: -2px; opacity: 0; animation: logoReveal 1.2s ease-out forwards; }
        @keyframes logoReveal { 0% { opacity: 0; transform: scale(0.9); } 100% { opacity: 1; transform: scale(1); } }
        @keyframes fadeOut { to { opacity: 0; visibility: hidden; } }

        /* --- 2. M√ÄN H√åNH CH√ÄO (WELCOME) --- */
        #empty-state {
            position: fixed; inset: 0; z-index: 50; background: var(--bg);
            display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px;
        }
        .login-card {
            background: var(--card-bg); width: 100%; max-width: 380px; padding: 40px 30px;
            border-radius: 24px; text-align: center; border: 1px solid var(--border);
            box-shadow: 0 20px 40px rgba(0,0,0,0.4); animation: slideUp 0.6s ease-out;
        }
        .icon-circle {
            width: 64px; height: 64px; background: #2c2c2e; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; margin: 0 auto 24px;
            font-size: 28px; color: #fff;
        }
        .btn-primary {
            background: #fff; color: #000; width: 100%; padding: 14px; border-radius: 12px;
            font-weight: 600; font-size: 15px; border: none; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s;
        }
        .btn-primary:active { transform: scale(0.98); opacity: 0.9; }

        /* --- 3. GIAO DI·ªÜN CH√çNH (DASHBOARD) --- */
        #dashboard { display: none; width: 100%; height: 100%; }
        
        /* THANH B√äN (SIDEBAR) */
        .sidebar {
            width: 280px; background: var(--sidebar); border-right: 1px solid var(--border);
            padding: 24px; display: flex; flex-direction: column; z-index: 100;
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .brand { font-size: 18px; font-weight: 700; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; flex-shrink: 0; }
        
        .sidebar-content { flex: 1; overflow-y: auto; padding-right: 5px; display: flex; flex-direction: column; gap: 20px; }
        
        /* 3 √î QU·∫¢NG C√ÅO NH·ªé */
        .sidebar-group-title { font-size: 11px; color: var(--text-secondary); text-transform: uppercase; font-weight: 700; margin-bottom: 8px; letter-spacing: 0.5px; }
        .sidebar-actions-grid { display: flex; flex-direction: column; gap: 8px; }
        
        .mini-box {
            background: #1a1a1c; padding: 12px; border-radius: 12px; border: 1px solid var(--border);
            display: flex; align-items: center; gap: 12px; cursor: pointer; transition: 0.2s;
        }
        .mini-box:hover { background: #252525; border-color: #444; }
        .mini-icon { color: var(--text-secondary); font-size: 14px; }
        .mini-text { font-size: 13px; font-weight: 500; color: #ddd; }

        /* √î SYSTEM ACTIVITY (TO V√Ä RI√äNG BI·ªÜT) */
        .system-activity-box {
            background: rgba(10, 132, 255, 0.05); /* M√†u xanh nh·∫°t */
            border: 1px solid rgba(10, 132, 255, 0.2);
            padding: 15px; border-radius: 16px; margin-top: auto; /* ƒê·∫©y xu·ªëng d∆∞·ªõi */
            cursor: pointer; transition: 0.2s;
        }
        .system-activity-box:hover { background: rgba(10, 132, 255, 0.1); }
        .sys-header { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .sys-title { font-size: 14px; font-weight: 700; color: var(--accent); }
        .sys-preview { font-size: 11px; color: var(--text-secondary); font-family: 'JetBrains Mono'; }

        /* N√öT TH√äM THI·∫æT B·ªä */
        .menu-footer { margin-top: 20px; flex-shrink: 0; }
        .menu-btn-add {
            width: 100%; background: var(--text-primary); color: var(--bg); border: none;
            padding: 12px; border-radius: 12px; font-weight: 600; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s;
        }

        /* KHUNG NH√åN CH√çNH (MAIN VIEW) */
        .main-view { flex: 1; display: flex; flex-direction: column; width: 100%; }
        .header {
            height: 60px; padding: 0 20px; border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
        }
        .mobile-toggle { display: none; font-size: 20px; cursor: pointer; }

        .device-grid {
            padding: 20px; overflow-y: auto; display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px;
        }

        /* TH·∫∫ THI·∫æT B·ªä (CARD) */
        .card {
            background: var(--card-bg); border: 1px solid var(--border); border-radius: 18px; padding: 20px;
            cursor: pointer; transition: all 0.3s ease; position: relative;
            animation: slideUp 0.5s ease forwards; opacity: 0;
        }
        .card:hover { transform: translateY(-4px); border-color: #555; }
        .card-head { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
        .c-avatar { width: 48px; height: 48px; border-radius: 12px; background: #333; object-fit: cover; }
        .c-status-badge { position: absolute; top: 20px; right: 20px; padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 600; }
        .bg-online { background: rgba(48, 209, 88, 0.15); color: #30d158; border: 1px solid rgba(48, 209, 88, 0.3); }
        .bg-offline { background: rgba(142, 142, 147, 0.15); color: #8e8e93; border: 1px solid rgba(142, 142, 147, 0.3); }
        .stat-row { display: flex; justify-content: space-between; margin-top: 10px; }
        .stat-l { font-size: 11px; color: var(--text-secondary); text-transform: uppercase; font-weight: 600; }
        .stat-v { font-size: 16px; font-weight: 700; font-family: 'JetBrains Mono'; }
        .session-info { font-size: 11px; color: var(--text-secondary); margin-top: 15px; padding-top: 10px; border-top: 1px solid #333; display: flex; justify-content: space-between; }

        /* --- C√ÅC C·ª¨A S·ªî (MODALS) --- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8); 
            z-index: 20000; /* Lu√¥n n·∫±m tr√™n c√πng */
            display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px);
            opacity: 0; transition: opacity 0.3s ease;
        }
        .modal-overlay.open { opacity: 1; }
        .modal { 
            background: #1c1c1e; padding: 24px; border-radius: 20px; width: 90%; max-width: 500px; 
            border: 1px solid #333; text-align: center; transform: scale(0.95); opacity: 0; 
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .modal-overlay.open .modal { transform: scale(1); opacity: 1; }

        /* --- C·ª¨A S·ªî B√ÅO L·ªñI (ERROR WINDOW) --- */
        .error-window {
            border: 1px solid var(--danger);
            background: #150505; /* N·ªÅn ƒë·ªè r·∫•t t·ªëi */
        }
        .err-icon { font-size: 40px; color: var(--danger); margin-bottom: 15px; }
        .err-code { font-size: 28px; font-weight: 800; color: var(--danger); margin-bottom: 5px; font-family: 'JetBrains Mono'; }
        .err-msg { font-size: 14px; color: #fff; margin-bottom: 20px; }
        .err-contact { 
            font-size: 12px; color: #888; border-top: 1px solid #330000; 
            padding-top: 15px; margin-top: 15px; 
        }
        .err-contact a { color: #fff; text-decoration: none; border-bottom: 1px dotted #fff; }

        /* INPUT STYLE */
        input { width: 100%; padding: 14px; border-radius: 10px; background: #2c2c2e; border: 1px solid #333; color: #fff; margin: 20px 0; outline: none; text-align: center; font-family: 'JetBrains Mono'; transition: 0.2s; }
        input:focus { border-color: #555; background: #333; }
        
        /* RESPONSIVE CHO ƒêI·ªÜN THO·∫†I */
        @media (max-width: 768px) {
            .sidebar { position: fixed; top: 0; bottom: 0; left: 0; width: 85%; max-width: 320px; transform: translateX(-100%); box-shadow: none; }
            .sidebar.open { transform: translateX(0); box-shadow: 10px 0 50px rgba(0,0,0,0.5); }
            .mobile-toggle { display: block; }
            .device-grid { grid-template-columns: 1fr; padding: 20px; }
            .overlay-menu { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 90; display: none; opacity: 0; transition: opacity 0.3s; }
            .overlay-menu.open { display: block; opacity: 1; }
        }
        
        /* KHUNG LOG SYSTEM */
        .log-container { text-align: left; max-height: 300px; overflow-y: auto; margin-top: 10px; border: 1px solid #333; border-radius: 10px; background: #111; }
        .log-entry { padding: 10px; border-bottom: 1px solid #222; font-size: 12px; font-family: 'JetBrains Mono'; display: flex; gap: 10px; }
        .log-time { color: #666; min-width: 60px; }
        .log-msg { color: #ccc; }
        
        .chart-box { height: 280px; width: 100%; margin: 20px 0; background: #151517; border-radius: 16px; border: 1px solid #333; padding: 15px; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="intro-layer"><div class="intro-logo">Evade.</div></div>

    <div id="empty-state">
        <div class="login-card">
            <div class="icon-circle"><i class="fa-brands fa-apple"></i></div>
            <h1>Welcome to Apple Hub</h1>
            <p style="color:#888; font-size:14px; margin-bottom:30px; line-height:1.5">
                Connect your Evade session to monitor stats.<br>Link up to 10 devices.
            </p>
            <button class="btn-primary" onclick="openLinkModal()">
                <i class="fa-solid fa-link"></i> Link Token ID
            </button>
        </div>
    </div>

    <div id="dashboard">
        <div class="overlay-menu" onclick="toggleMenu()"></div>
        
        <div class="sidebar" id="sidebar">
            <div class="brand"><i class="fa-brands fa-apple"></i> Apple Hub</div>
            
            <div class="sidebar-content">
                <div class="sidebar-group-title">QUICK ACTIONS</div>
                <div class="sidebar-actions-grid">
                    <div class="mini-box" onclick="openLinkModal()">
                        <i class="fa-solid fa-link mini-icon"></i>
                        <span class="mini-text">Connect Device</span>
                    </div>
                    <div class="mini-box">
                        <i class="fa-solid fa-code mini-icon"></i>
                        <span class="mini-text">Supported Executors</span>
                    </div>
                    <div class="mini-box">
                        <i class="fa-brands fa-discord mini-icon"></i>
                        <span class="mini-text">Need Help?</span>
                    </div>
                </div>

                <div class="system-activity-box" onclick="openLogsModal()">
                    <div class="sys-header">
                        <i class="fa-solid fa-pulse" style="color:var(--accent)"></i>
                        <span class="sys-title">System Activity</span>
                    </div>
                    <div class="sys-preview" id="sys-last-log">System Ready...</div>
                </div>
            </div>

            <div class="menu-footer">
                <div id="device-count" style="text-align:center; font-size:12px; color:#666; margin-bottom:10px;">0 / 10 Devices</div>
                <button class="menu-btn-add" onclick="openLinkModal()">
                    <i class="fa-solid fa-link"></i> Link New Device
                </button>
            </div>
        </div>

        <div class="main-view">
            <div class="header">
                <i class="fa-solid fa-bars mobile-toggle" onclick="toggleMenu()"></i>
                <div style="font-weight:600">Dashboard</div>
                <div style="width:20px"></div>
            </div>
            <div class="device-grid" id="grid"></div>
        </div>
    </div>

    <div class="modal-overlay" id="link-modal">
        <div class="modal">
            <h3>Link Device</h3>
            <p style="color:#888; font-size:12px; margin-top:5px">Enter Token ID from script.</p>
            <input id="token-input" placeholder="Paste Token Here...">
            <button class="btn-primary" onclick="addToken()">Connect</button>
            <div style="margin-top:15px; font-size:13px; color:#666; cursor:pointer" onclick="closeLinkModal()">Cancel</div>
        </div>
    </div>

    <div class="modal-overlay" id="detail-modal">
        <div class="modal">
            <div style="display:flex; justify-content:space-between">
                <h3 id="d-name">User</h3>
                <i class="fa-solid fa-xmark" style="cursor:pointer; color:#666" onclick="closeDetailModal()"></i>
            </div>
            <div id="d-token" style="font-family:monospace; font-size:11px; color:#666; margin-top:5px"></div>

            <div style="background:#222; border-radius:8px; padding:10px; margin-top:15px; font-size:12px; color:#aaa; display:flex; justify-content:space-between;">
                <span>Status:</span>
                <span id="d-session-status" style="color:#fff; font-weight:600">Checking...</span>
            </div>

            <div class="chart-box"><canvas id="chart"></canvas></div>

            <div style="display:flex; gap:15px; margin-top:15px">
                <div style="flex:1; background:#2c2c2e; padding:10px; border-radius:10px">
                    <div style="font-size:10px; color:#888">MONEY/HR</div>
                    <div id="g-money" style="font-weight:700">...</div>
                </div>
                <div style="flex:1; background:#2c2c2e; padding:10px; border-radius:10px">
                    <div style="font-size:10px; color:#888">LEVEL/HR</div>
                    <div id="g-level" style="font-weight:700">...</div>
                </div>
            </div>

            <button onclick="removeToken()" style="width:100%; padding:12px; margin-top:20px; background:rgba(255,69,58,0.1); color:#ff453a; border:1px solid rgba(255,69,58,0.2); border-radius:10px; font-weight:600; cursor:pointer">Unlink Device</button>
        </div>
    </div>

    <div class="modal-overlay" id="error-modal">
        <div class="modal error-window">
            <i class="fa-solid fa-triangle-exclamation err-icon"></i>
            <div class="err-code" id="err-code-display">ERR-000</div>
            <div class="err-msg" id="err-msg-display">Something went wrong</div>
            
            <button onclick="closeErrorModal()" style="background:#fff; color:#000; border:none; padding:10px 20px; border-radius:8px; font-weight:600; cursor:pointer;">Close</button>
            
            <div class="err-contact">
                <a href="#">Contact Developer for support</a>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="logs-modal">
        <div class="modal" style="max-width: 600px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px">
                <h3>System Activity</h3>
                <i class="fa-solid fa-xmark" style="cursor:pointer" onclick="closeLogsModal()"></i>
            </div>
            <div class="log-container" id="log-list">
                </div>
            <button onclick="clearLogs()" style="margin-top:15px; background:transparent; border:1px solid #444; color:#888; padding:8px 16px; border-radius:8px; cursor:pointer">Clear History</button>
        </div>
    </div>

    <script>
        // --- C·∫§U H√åNH DATABASE ---
        const DB_URL = "https://apple-hub-f43e4-default-rtdb.asia-southeast1.firebasedatabase.app/";
        
        // --- BI·∫æN TO√ÄN C·ª§C ---
        let tokens = JSON.parse(localStorage.getItem('apple_tokens_v16')) || [];
        let systemLogs = JSON.parse(localStorage.getItem('system_logs_v16')) || [];
        let curToken = null;
        let chart = null;

        // --- KH·ªûI T·∫†O ·ª®NG D·ª§NG ---
        setTimeout(() => checkState(), 1500); // Ch·ªù Intro ch·∫°y xong

        function checkState() {
            if (tokens.length === 0) {
                // Ch∆∞a c√≥ Token -> Hi·ªán Welcome, ·∫©n Dashboard
                document.getElementById('empty-state').style.display = 'flex';
                document.getElementById('dashboard').style.display = 'none';
            } else {
                // ƒê√£ c√≥ Token -> Hi·ªán Dashboard
                document.getElementById('empty-state').style.display = 'none';
                document.getElementById('dashboard').style.display = 'flex';
                renderGrid();
                // Ch·∫°y v√≤ng l·∫∑p c·∫≠p nh·∫≠t
                if(!window.refreshInt) window.refreshInt = setInterval(renderGrid, 5000);
                if(!window.clockInt) window.clockInt = setInterval(updateLiveTimes, 1000);
            }
            document.getElementById('device-count').innerText = `${tokens.length} / 10 Devices`;
        }

        // --- H·ªÜ TH·ªêNG X·ª¨ L√ù L·ªñI (ERROR WINDOW) ---
        function showError(code, message) {
            document.getElementById('err-code-display').innerText = `ERR-${code}`;
            document.getElementById('err-msg-display').innerText = message;
            openModalAnim('error-modal');
        }
        function closeErrorModal() { closeModalAnim('error-modal'); }

        // --- H·ªÜ TH·ªêNG LOG (SYSTEM ACTIVITY - KH√îNG PH·∫¢I L·ªñI) ---
        function logActivity(msg) {
            const time = new Date().toLocaleTimeString();
            const entry = { time, msg };
            
            // C·∫≠p nh·∫≠t Preview b√™n ngo√†i
            document.getElementById('sys-last-log').innerText = `${time} - ${msg}`;
            
            // L∆∞u v√†o m·∫£ng
            systemLogs.unshift(entry);
            if(systemLogs.length > 50) systemLogs.pop(); // Gi·ªØ t·ªëi ƒëa 50 d√≤ng
            localStorage.setItem('system_logs_v16', JSON.stringify(systemLogs));
        }

        function renderLogs() {
            const c = document.getElementById('log-list');
            c.innerHTML = '';
            systemLogs.forEach(l => {
                c.innerHTML += `
                    <div class="log-entry">
                        <span class="log-time">${l.time}</span>
                        <span class="log-msg">${l.msg}</span>
                    </div>
                `;
            });
        }
        
        function clearLogs() {
            systemLogs = [];
            localStorage.setItem('system_logs_v16', JSON.stringify([]));
            renderLogs();
            document.getElementById('sys-last-log').innerText = "Logs cleared.";
        }

        // --- C√ÅC H√ÄM UI (ANIMATION) ---
        function toggleMenu() { 
            document.getElementById('sidebar').classList.toggle('open'); 
            document.querySelector('.overlay-menu').classList.toggle('open'); 
        }
        function openModalAnim(id) {
            const el = document.getElementById(id);
            el.style.display = 'flex'; el.offsetHeight; el.classList.add('open');
        }
        function closeModalAnim(id) {
            const el = document.getElementById(id);
            el.classList.remove('open'); setTimeout(() => { el.style.display = 'none'; }, 300);
        }
        
        // Wrapper functions
        function openLinkModal() { openModalAnim('link-modal'); }
        function closeLinkModal() { closeModalAnim('link-modal'); }
        function closeDetailModal() { closeModalAnim('detail-modal'); }
        function openLogsModal() { renderLogs(); openModalAnim('logs-modal'); }
        function closeLogsModal() { closeModalAnim('logs-modal'); }

        // --- LOGIC TH√äM TOKEN ---
        function addToken() {
            try {
                const val = document.getElementById('token-input').value.trim();
                
                // Ki·ªÉm tra l·ªói ƒë·∫ßu v√†o
                if (!val) { showError(1001, "Token input cannot be empty."); return; }
                if (tokens.length >= 10) { showError(1002, "Device limit reached (Max 10)."); return; }
                if (tokens.includes(val)) { showError(1003, "Device already linked."); return; }

                // Th√™m Token
                tokens.push(val);
                localStorage.setItem('apple_tokens_v16', JSON.stringify(tokens));
                
                logActivity(`Linked new device: ${val.substring(0,6)}...`);
                
                document.getElementById('token-input').value = '';
                closeLinkModal();
                checkState();
                renderGrid();
            } catch(e) {
                showError(9999, "Unknown system error.");
            }
        }

        function removeToken() {
            if(confirm('Unlink this device?')) {
                logActivity(`Unlinked device: ${curToken.substring(0,6)}...`);
                tokens = tokens.filter(t => t !== curToken);
                localStorage.setItem('apple_tokens_v16', JSON.stringify(tokens));
                closeDetailModal();
                checkState();
            }
        }

        function formatTime(seconds) {
            if(seconds < 0) seconds = 0;
            const h = Math.floor(seconds / 3600).toString().padStart(2, '0');
            const m = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
            const s = (seconds % 60).toString().padStart(2, '0');
            return `${h}:${m}:${s}`;
        }

        // --- RENDER DANH S√ÅCH THI·∫æT B·ªä ---
        async function renderGrid() {
            if(tokens.length === 0) return;
            const grid = document.getElementById('grid');
            grid.innerHTML = ''; 

            let idx = 0;
            for(const t of tokens) {
                const card = document.createElement('div');
                card.className = 'card';
                card.style.animationDelay = (idx * 0.1) + 's'; idx++;
                card.innerHTML = `<small style="color:#666">Loading data...</small>`;
                grid.appendChild(card);

                try {
                    const res = await fetch(`${DB_URL}Users/${t}/Current.json`);
                    
                    // N·∫øu l·ªói m·∫°ng -> Hi·ªán c·ª≠a s·ªï l·ªói
                    if(!res.ok) { showError(2001, `Connection failed for ${t}`); throw new Error(); }
                    
                    const d = await res.json();
                    // N·∫øu kh√¥ng c√≥ d·ªØ li·ªáu -> B√°o l·ªói d·ªØ li·ªáu
                    if(!d) { showError(2003, `No data found for token ${t}`); throw new Error(); }

                    const now = Date.now() / 1000;
                    const lastUpd = d.LastUpdated || 0;
                    const isOnline = (now - lastUpd) < 90;
                    let avatar = d.Avatar || "https://tr.rbxcdn.com/53eb9b17fe1432a802c7eb904f13499e/150/150/AvatarHeadshot/Png";

                    let timeText = "";
                    let badgeClass = isOnline ? "bg-online" : "bg-offline";
                    let badgeText = isOnline ? "LIVE" : "OFFLINE";
                    
                    if (isOnline) {
                        const start = d.StartTime || lastUpd;
                        const uptimeSec = Math.floor(now - start);
                        timeText = `Running: <span class="live-clock" data-start="${start}">${formatTime(uptimeSec)}</span>`;
                    } else {
                        const date = new Date(lastUpd * 1000);
                        timeText = `Disconnected at ${date.getHours().toString().padStart(2,'0')}:${date.getMinutes().toString().padStart(2,'0')}`;
                    }

                    card.innerHTML = `
                        <div class="c-status-badge ${badgeClass}">${badgeText}</div>
                        <div class="card-head">
                            <img src="${avatar}" class="c-avatar" onerror="this.src='https://tr.rbxcdn.com/53eb9b17fe1432a802c7eb904f13499e/150/150/AvatarHeadshot/Png'">
                            <div>
                                <div style="font-weight:600; font-size:15px">${d.Username || 'Unknown'}</div>
                                <div style="font-size:11px; color:#666; font-family:monospace">${t.substring(0,8)}...</div>
                            </div>
                        </div>
                        <div class="stat-row">
                            <div><div class="stat-l">BALANCE</div><div class="stat-v">$${(d.Money||0).toLocaleString()}</div></div>
                            <div style="text-align:right"><div class="stat-l">LEVEL</div><div class="stat-v">${d.Level||0}</div></div>
                        </div>
                        <div class="session-info"><span>${timeText}</span></div>
                    `;
                    card.onclick = () => showDetail(t, d, isOnline, timeText);
                } catch(e) {
                    card.innerHTML = `<small style="color:#ff453a">Load Failed</small>`;
                    card.onclick = () => { curToken = t; removeToken(); }
                }
            }
        }

        // C·∫≠p nh·∫≠t ƒë·ªìng h·ªì th·ªùi gian th·ª±c
        function updateLiveTimes() {
            const clocks = document.querySelectorAll('.live-clock');
            const now = Date.now() / 1000;
            clocks.forEach(c => {
                const start = parseFloat(c.getAttribute('data-start'));
                if(start) c.innerText = formatTime(Math.floor(now - start));
            });
        }

        // --- HI·ªÇN TH·ªä CHI TI·∫æT ---
        async function showDetail(t, d, isOnline, timeText) {
            try {
                curToken = t;
                document.getElementById('d-name').innerText = d.Username;
                document.getElementById('d-token').innerText = t;
                
                const statusEl = document.getElementById('d-session-status');
                statusEl.innerHTML = timeText.replace("span", "b"); 
                statusEl.style.color = isOnline ? "#30d158" : "#888";

                openModalAnim('detail-modal'); 
                
                logActivity(`Opened detail view for ${d.Username}`);

                const hRes = await fetch(`${DB_URL}Users/${t}/History.json`);
                if(!hRes.ok) throw new Error();
                
                const hData = await hRes.json();
                const points = Object.values(hData || {}).slice(-30);
                
                calcGrowth(hData);
                initChart(points);
            } catch (e) {
                showError(5001, "Failed to load history data.");
            }
        }

        // --- T√çNH TO√ÅN TƒÇNG TR∆Ø·ªûNG ---
        function calcGrowth(history) {
            try {
                const points = Object.values(history||{});
                if(points.length < 2) throw new Error();
                const f = points[0]; const l = points[points.length-1];
                const diff = l.Time - f.Time;
                if(diff <= 0) throw new Error();
                
                const mHr = ((l.Money - f.Money)/diff)*3600;
                const lHr = ((l.Level - f.Level)/diff)*3600;
                
                document.getElementById('g-money').innerText = "+$"+Math.max(0, Math.floor(mHr)).toLocaleString();
                document.getElementById('g-level').innerText = "+"+Math.max(0, lHr.toFixed(1));
            } catch(e) {
                document.getElementById('g-money').innerText = "...";
                document.getElementById('g-level').innerText = "...";
            }
        }

        // --- V·∫º BI·ªÇU ƒê·ªí (CHART.JS) ---
        function initChart(points) {
            const ctx = document.getElementById('chart').getContext('2d');
            if(chart) chart.destroy();

            if(!points || points.length === 0) { showError(3001, "Chart data empty"); return; }

            const gradM = ctx.createLinearGradient(0,0,0,300);
            gradM.addColorStop(0, 'rgba(10, 132, 255, 0.2)'); gradM.addColorStop(1, 'rgba(10, 132, 255, 0)');

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: points.map(p => new Date(p.Time * 1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})),
                    datasets: [
                        { label: 'Money', data: points.map(p=>p.Money), borderColor: '#0a84ff', backgroundColor: gradM, borderWidth: 2, fill:true, pointRadius: 0, pointHoverRadius: 6, tension: 0.4, yAxisID: 'y' },
                        { label: 'Level', data: points.map(p=>p.Level), borderColor: '#bf5af2', borderWidth: 2, borderDash: [4,4], pointRadius: 0, pointHoverRadius: 6, tension: 0.4, yAxisID: 'y1' }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(28, 28, 30, 0.95)',
                            titleColor: '#fff', bodyColor: '#ccc', borderColor: '#333', borderWidth: 1, padding: 12,
                            displayColors: true,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label === 'Money') return ` üíµ $${context.parsed.y.toLocaleString()}`;
                                    if (label === 'Level') return ` ‚≠ê Lv. ${context.parsed.y}`;
                                    return label;
                                }
                            }
                        }
                    },
                    scales: { 
                        x: { display: false }, 
                        y: { display: false, position: 'left' }, 
                        y1: { display: false, position: 'right', grid: { drawOnChartArea: false } } 
                    }
                }
            });
        }
    </script>
</body>
</html>
